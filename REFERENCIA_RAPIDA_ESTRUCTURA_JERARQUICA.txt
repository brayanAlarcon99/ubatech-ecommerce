# âš¡ REFERENCIA RÃPIDA: Norma de Estructura JerÃ¡rquica

## ğŸ¯ La Norma en Una LÃ­nea

**Si un producto tiene subcategorÃ­a, DEBE estar reflejada en la categorÃ­a principal.**

---

## ğŸ“‹ Estructura Obligatoria

```
CATEGORÃA PRINCIPAL
  â””â”€ SUBCATEGORÃA (opcional)
      â””â”€ PRODUCTO
```

### Ejemplo Real

```
CELULARES (categorÃ­a)
  â”œâ”€ SAMSUNG (subcategorÃ­a)
  â”‚   â”œâ”€ Galaxy A13
  â”‚   â””â”€ Galaxy S23
  â”‚
  â”œâ”€ REDMI (subcategorÃ­a)
  â”‚   â”œâ”€ NOTE14PRO+
  â”‚   â””â”€ Note 13
  â”‚
  â””â”€ IPHONE (subcategorÃ­a)
      â””â”€ iPhone 15 Pro
```

---

## âœ… Validaciones (AutomÃ¡ticas)

| AcciÃ³n | ValidaciÃ³n | Resultado |
|--------|-----------|-----------|
| Crear producto con subcategorÃ­a | Â¿SubcategorÃ­a existe? Â¿Pertenece a la categorÃ­a? | âœ… SÃ­/SÃ­ â†’ Guardar |
| Crear producto sin subcategorÃ­a | - | âœ… Siempre permitido |
| Eliminar categorÃ­a con productos | Â¿Tiene productos? | âŒ No permitido |
| Eliminar subcategorÃ­a con productos | Â¿Tiene productos? | âŒ No permitido |
| Agregar subcategorÃ­a | Â¿CategorÃ­a existe? | âœ… SÃ­ â†’ Crear |

---

## ğŸš€ Uso en Panel Admin

### Crear Producto

```javascript
1. Selecciona CategorÃ­a: "Celulares"
2. Sistema carga: ["Samsung", "Redmi", "iPhone"]
3. Selecciona SubcategorÃ­a: "Redmi"
4. Sistema valida: âœ… Redmi pertenece a Celulares
5. Guardar â†’ âœ… Producto creado
```

### Eliminar CategorÃ­a

```javascript
1. Admin intenta eliminar: "Celulares"
2. Sistema verifica: Â¿Productos en Celulares?
3. Resultado: SÃ­, 40 productos
4. Sistema bloquea: âŒ No se puede eliminar
```

---

## ğŸ—‚ï¸ Estructura en Firebase

### collections/categories
```json
{ "id": "cat_001", "name": "Celulares" }
```

### collections/subcategories
```json
{ "id": "sub_001", "name": "Redmi", "categoryId": "cat_001" }
```

### collections/products
```json
{
  "id": "prod_001",
  "name": "NOTE14PRO+",
  "category": "Celulares",        â† Nombre de categorÃ­a
  "subcategory": "sub_001"        â† ID de subcategorÃ­a
}
```

---

## ğŸ” Firestore Rules (Resumen)

```firestore
// Permite crear producto SI:
// 1. Usuario es admin
// 2. Si hay subcategorÃ­a: existe y pertenece a la categorÃ­a

allow create: if isAdmin() && validateHierarchy();

function validateHierarchy() {
  let product = request.resource.data;
  if (!product.subcategory) return true;  // OK sin subcategorÃ­a
  
  let sub = getSubcategory(product.subcategory);
  return sub.categoryId == getCategoryId(product.category);
}
```

---

## ğŸ¨ Vista Cliente (Tienda)

```
CATEGORÃA: CELULARES
â”œâ”€ MenÃº Lateral: Filtrar por...
â”‚  â”œâ”€ â˜‘ Samsung
â”‚  â”œâ”€ â˜‘ Redmi
â”‚  â”œâ”€ â˜‘ iPhone
â”‚  â””â”€ â˜‘ Otro
â”‚
â””â”€ Productos:
   â”œâ”€ Galaxy A13 (Samsung)
   â”œâ”€ NOTE14PRO+ (Redmi)
   â”œâ”€ iPhone 15 (iPhone)
   â””â”€ Producto GenÃ©rico
```

---

## ğŸ“¡ Funciones JavaScript (lib/subcategories.ts)

### Validar Producto
```typescript
const { valid, error } = await validateProductHierarchy({
  category: "Celulares",
  subcategory: "sub_redmi_001"
});
if (!valid) console.error(error);
```

### Obtener SubcategorÃ­as
```typescript
const subs = await getSubcategoriesByCategory("cat_001");
// Retorna: [{id, name, categoryId}, ...]
```

---

## âŒ Errores Comunes

| Error | Causa | SoluciÃ³n |
|-------|-------|----------|
| "SubcategorÃ­a no pertenece a esta categorÃ­a" | Seleccionaste subcategorÃ­a de otra categorÃ­a | Reselecciona la subcategorÃ­a correcta |
| "No se puede eliminar, tiene productos" | Intentas eliminar categorÃ­a/subcategorÃ­a con productos | Primero elimina o reasigna los productos |
| "SubcategorÃ­a no existe" | El ID de subcategorÃ­a es invÃ¡lido | Crea la subcategorÃ­a primero |

---

## ğŸ” VerificaciÃ³n RÃ¡pida

```bash
# Â¿El producto aparece en la categorÃ­a?
firebase.firestore.getDocs("products", {category: "Celulares"})
â†’ Si contiene el producto â†’ âœ… OK

# Â¿La subcategorÃ­a existe?
firebase.firestore.getDoc("subcategories/sub_redmi_001")
â†’ Si existe y categoryId es correcto â†’ âœ… OK

# Â¿Hay conflictos de referencia?
Buscar productos donde subcategorÃ­a no existe
â†’ Si hay â†’ âŒ Error, revisar base de datos
```

---

## ğŸ“ Archivos Relacionados

| Archivo | DescripciÃ³n |
|---------|-------------|
| `FIRESTORE_RULES_CORRECTAS.txt` | Reglas Firestore con validaciones |
| `NORMA_ESTRUCTURA_JERARQUICA.md` | DocumentaciÃ³n completa |
| `GUIA_VISUAL_ESTRUCTURA_JERARQUICA.md` | Diagramas y flujos visuales |
| `lib/subcategories.ts` | Funciones de validaciÃ³n |
| `components/admin/product-form.tsx` | Interfaz de creaciÃ³n de productos |

---

**Â¿Necesitas ayuda?** Revisa el archivo completo en `NORMA_ESTRUCTURA_JERARQUICA.md`
